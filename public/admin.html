<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>لوحة التحكم - سولارا</title>
  
  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          fontFamily: { arabic: ['Cairo', 'sans-serif'] },
          colors: {
            obsidian: '#050505',
            solar: { gold: '#fbbf24', light: '#fcd34d' }
          }
        }
      }
    }
  </script>
  
  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
  
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
  <!-- GSAP -->
  <script src="https://cdn.jsdelivr.net/npm/gsap@3.12.5/dist/gsap.min.js"></script>
  
  <style>
    html { scroll-behavior: smooth; }
    body { 
      font-family: 'Cairo', sans-serif; 
      background: #050505;
      color: #f3f4f6;
    }
    
    /* Stats Card Animation */
    .stat-card {
      background: linear-gradient(135deg, rgba(255,255,255,0.05), rgba(255,255,255,0.02));
      backdrop-filter: blur(20px);
      border: 1px solid rgba(251, 191, 36, 0.1);
      transition: all 0.3s ease;
    }
    .stat-card:hover {
      transform: translateY(-5px);
      border-color: rgba(251, 191, 36, 0.3);
      box-shadow: 0 20px 40px rgba(251, 191, 36, 0.1);
    }
    
    /* Table */
    .data-table {
      background: rgba(255, 255, 255, 0.02);
      border-collapse: separate;
      border-spacing: 0;
    }
    .data-table th {
      background: rgba(251, 191, 36, 0.1);
      border-bottom: 1px solid rgba(251, 191, 36, 0.2);
      padding: 1rem;
      text-align: right;
      font-weight: 600;
    }
    .data-table td {
      padding: 1rem;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    }
    .data-table tr:hover td {
      background: rgba(251, 191, 36, 0.05);
    }
    
    /* Type Badge */
    .type-badge {
      padding: 0.25rem 0.75rem;
      border-radius: 9999px;
      font-size: 0.75rem;
      font-weight: 600;
    }
    .type-residential { background: rgba(34, 197, 94, 0.2); color: #22c55e; }
    .type-commercial { background: rgba(251, 191, 36, 0.2); color: #fbbf24; }
    .type-industrial { background: rgba(59, 130, 246, 0.2); color: #3b82f6; }
    
    /* Loading */
    .loader {
      border: 3px solid rgba(251, 191, 36, 0.1);
      border-top-color: #fbbf24;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    
    /* Sidebar */
    .sidebar {
      background: linear-gradient(180deg, #0a0a0a, #050505);
      border-right: 1px solid rgba(251, 191, 36, 0.1);
    }
    .sidebar-link {
      padding: 0.75rem 1rem;
      border-radius: 0.5rem;
      transition: all 0.3s ease;
      color: #9ca3af;
    }
    .sidebar-link:hover, .sidebar-link.active {
      background: rgba(251, 191, 36, 0.1);
      color: #fbbf24;
    }
  </style>
</head>
<body class="font-arabic">
  <div class="flex min-h-screen">
    <!-- Sidebar -->
    <aside class="w-64 sidebar min-h-screen p-4 flex flex-col">
      <div class="flex items-center gap-3 mb-8 px-2">
        <i class="fas fa-sun text-solar-gold text-2xl"></i>
        <span class="text-white text-xl font-bold">SOLARA</span>
      </div>
      
      <nav class="flex-1 space-y-2">
        <a href="#" class="sidebar-link active flex items-center gap-3">
          <i class="fas fa-chart-line w-5"></i>
          لوحة التحكم
        </a>
        <a href="/" class="sidebar-link flex items-center gap-3">
          <i class="fas fa-home w-5"></i>
          الرئيسية
        </a>
      </nav>
      
      <div class="pt-4 border-t border-white/10">
        <p class="text-xs text-gray-500 text-center">لوحة تحكم سولارا</p>
      </div>
    </aside>

    <!-- Main -->
    <main class="flex-1 p-8">
      <!-- Header -->
      <div class="flex justify-between items-center mb-8">
        <div>
          <h1 class="text-3xl font-bold text-white">لوحة التحكم</h1>
          <p class="text-gray-400 mt-1">إدارة العملاء والطلبات</p>
        </div>
        <div class="flex gap-3">
          <button onclick="refreshData()" class="bg-white/10 hover:bg-white/20 text-white px-4 py-2 rounded-lg transition flex items-center gap-2">
            <i class="fas fa-sync-alt"></i>
            تحديث
          </button>
          <button onclick="exportData()" class="bg-solar-gold/20 hover:bg-solar-gold/30 text-solar-gold px-4 py-2 rounded-lg transition flex items-center gap-2">
            <i class="fas fa-download"></i>
            تصدير
          </button>
        </div>
      </div>

      <!-- Stats Cards -->
      <div class="grid grid-cols-4 gap-6 mb-8">
        <div class="stat-card rounded-2xl p-6">
          <div class="flex items-center justify-between mb-4">
            <div class="w-12 h-12 bg-solar-gold/20 rounded-xl flex items-center justify-center">
              <i class="fas fa-users text-solar-gold text-xl"></i>
            </div>
          </div>
          <p class="text-gray-400 text-sm">إجمالي الطلبات</p>
          <p class="text-3xl font-bold text-white mt-1" id="totalCount">0</p>
        </div>
        
        <div class="stat-card rounded-2xl p-6">
          <div class="flex items-center justify-between mb-4">
            <div class="w-12 h-12 bg-green-500/20 rounded-xl flex items-center justify-center">
              <i class="fas fa-home text-green-400 text-xl"></i>
            </div>
          </div>
          <p class="text-gray-400 text-sm">سكني</p>
          <p class="text-3xl font-bold text-white mt-1" id="residentialCount">0</p>
        </div>
        
        <div class="stat-card rounded-2xl p-6">
          <div class="flex items-center justify-between mb-4">
            <div class="w-12 h-12 bg-solar-gold/20 rounded-xl flex items-center justify-center">
              <i class="fas fa-building text-solar-gold text-xl"></i>
            </div>
          </div>
          <p class="text-gray-400 text-sm">تجاري</p>
          <p class="text-3xl font-bold text-white mt-1" id="commercialCount">0</p>
        </div>
        
        <div class="stat-card rounded-2xl p-6">
          <div class="flex items-center justify-between mb-4">
            <div class="w-12 h-12 bg-blue-500/20 rounded-xl flex items-center justify-center">
              <i class="fas fa-industry text-blue-400 text-xl"></i>
            </div>
          </div>
          <p class="text-gray-400 text-sm">صناعي</p>
          <p class="text-3xl font-bold text-white mt-1" id="industrialCount">0</p>
        </div>
      </div>

      <!-- Charts -->
      <div class="grid grid-cols-2 gap-6 mb-8">
        <!-- Pie Chart -->
        <div class="stat-card rounded-2xl p-6">
          <h3 class="text-lg font-semibold text-white mb-4">توزيع الطلبات</h3>
          <div class="h-64">
            <canvas id="pieChart"></canvas>
          </div>
        </div>
        
        <!-- Line Chart -->
        <div class="stat-card rounded-2xl p-6">
          <h3 class="text-lg font-semibold text-white mb-4">الطلبات حسب الشهر</h3>
          <div class="h-64">
            <canvas id="lineChart"></canvas>
          </div>
        </div>
      </div>

      <!-- Data Table -->
      <div class="stat-card rounded-2xl overflow-hidden">
        <div class="p-6 border-b border-white/10">
          <h3 class="text-lg font-semibold text-white">العملاء</h3>
        </div>
        
        <!-- Loading -->
        <div id="loadingState" class="p-12 text-center">
          <div class="loader mx-auto mb-4"></div>
          <p class="text-gray-400">جاري تحميل البيانات...</p>
        </div>
        
        <!-- Empty -->
        <div id="emptyState" class="hidden p-12 text-center">
          <i class="fas fa-inbox text-gray-600 text-5xl mb-4"></i>
          <p class="text-gray-400">لا توجد بيانات</p>
        </div>
        
        <!-- Table -->
        <div id="tableState" class="hidden overflow-x-auto">
          <table class="data-table w-full">
            <thead>
              <tr>
                <th>#</th>
                <th>الاسم</th>
                <th>الهاتف</th>
                <th>البريد</th>
                <th>الولاية</th>
                <th>النوع</th>
                <th>التاريخ</th>
              </tr>
            </thead>
            <tbody id="leadsTableBody">
            </tbody>
          </table>
        </div>
      </div>
    </main>
  </div>

  <script>
    // Charts
    let pieChart = null;
    let lineChart = null;
    
    function formatDate(dateStr) {
      const date = new Date(dateStr);
      return date.toLocaleDateString('ar-SA', {
        year: 'numeric',
        month: 'short',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });
    }
    
    function renderCharts(stats) {
      // Pie Chart
      const pieCtx = document.getElementById('pieChart').getContext('2d');
      if (pieChart) pieChart.destroy();
      
      pieChart = new Chart(pieCtx, {
        type: 'doughnut',
        data: {
          labels: ['سكني', 'تجاري', 'صناعي'],
          datasets: [{
            data: [stats.residential, stats.commercial, stats.industrial],
            backgroundColor: [
              'rgba(34, 197, 94, 0.8)',
              'rgba(251, 191, 36, 0.8)',
              'rgba(59, 130, 246, 0.8)'
            ],
            borderColor: ['#22c55e', '#fbbf24', '#3b82f6'],
            borderWidth: 2
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'bottom',
              labels: { color: '#9ca3af', font: { family: 'Cairo' } }
            }
          }
        }
      });
    }
    
    function renderLineChart(leads) {
      // Group by month
      const months = {};
      const now = new Date();
      for (let i = 5; i >= 0; i--) {
        const d = new Date(now.getFullYear(), now.getMonth() - i, 1);
        const key = d.toLocaleDateString('ar-SA', { month: 'short', year: 'numeric' });
        months[key] = 0;
      }
      
      leads.forEach(lead => {
        const date = new Date(lead.date);
        const key = date.toLocaleDateString('ar-SA', { month: 'short', year: 'numeric' });
        if (months[key] !== undefined) months[key]++;
      });
      
      const lineCtx = document.getElementById('lineChart').getContext('2d');
      if (lineChart) lineChart.destroy();
      
      lineChart = new Chart(lineCtx, {
        type: 'line',
        data: {
          labels: Object.keys(months),
          datasets: [{
            label: 'الطلبات',
            data: Object.values(months),
            borderColor: '#fbbf24',
            backgroundColor: 'rgba(251, 191, 36, 0.1)',
            fill: true,
            tension: 0.4,
            pointBackgroundColor: '#fbbf24',
            pointBorderColor: '#050505',
            pointBorderWidth: 2
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: true,
              ticks: { color: '#9ca3af' },
              grid: { color: 'rgba(255,255,255,0.05)' }
            },
            x: {
              ticks: { color: '#9ca3af' },
              grid: { color: 'rgba(255,255,255,0.05)' }
            }
          },
          plugins: {
            legend: { display: false }
          }
        }
      });
    }
    
    function renderTable(leads) {
      const tbody = document.getElementById('leadsTableBody');
      tbody.innerHTML = '';
      
      leads.forEach((lead, index) => {
        const typeClass = lead.type === 'Residential' ? 'type-residential' : 
                         lead.type === 'Commercial' ? 'type-commercial' : 'type-industrial';
        
        const row = document.createElement('tr');
        row.innerHTML = `
          <td class="text-gray-500">${index + 1}</td>
          <td class="font-semibold text-white">${lead.name}</td>
          <td><a href="tel:${lead.phone}" class="text-solar-gold hover:underline">${lead.phone}</a></td>
          <td class="text-gray-400">${lead.email || '-'}</td>
          <td><span class="bg-white/10 px-3 py-1 rounded-full text-sm">${lead.city || '-'}</span></td>
          <td><span class="type-badge ${typeClass}">${lead.type === 'Residential' ? 'سكني' : lead.type === 'Commercial' ? 'تجاري' : 'صناعي'}</span></td>
          <td class="text-gray-500 text-sm">${formatDate(lead.date)}</td>
        `;
        tbody.appendChild(row);
      });
    }
    
    function showLoading() {
      document.getElementById('loadingState').classList.remove('hidden');
      document.getElementById('emptyState').classList.add('hidden');
      document.getElementById('tableState').classList.add('hidden');
    }
    
    function showData() {
      document.getElementById('loadingState').classList.add('hidden');
      document.getElementById('emptyState').classList.add('hidden');
      document.getElementById('tableState').classList.remove('hidden');
    }
    
    function showEmpty() {
      document.getElementById('loadingState').classList.add('hidden');
      document.getElementById('emptyState').classList.remove('hidden');
      document.getElementById('tableState').classList.add('hidden');
    }
    
    function updateStats(stats) {
      // GSAP animation
      gsap.to('#totalCount', { duration: 1, innerText: stats.total, snap: { innerText: 1 } });
      gsap.to('#residentialCount', { duration: 1, innerText: stats.residential, snap: { innerText: 1 } });
      gsap.to('#commercialCount', { duration: 1, innerText: stats.commercial, snap: { innerText: 1 } });
      gsap.to('#industrialCount', { duration: 1, innerText: stats.industrial, snap: { innerText: 1 } });
    }
    
    async function refreshData() {
      showLoading();
      
      try {
        const res = await fetch('/api/v1/vault/secure-data-7721');
        const response = await res.json();
        
        if (response.success) {
          const { leads, stats } = response.data;
          
          updateStats(stats);
          renderCharts(stats);
          renderLineChart(leads);
          
          if (leads.length === 0) {
            showEmpty();
          } else {
            renderTable(leads);
            showData();
          }
        }
      } catch (error) {
        console.error('Error:', error);
        showEmpty();
      }
    }
    
    function exportData() {
      // Simple CSV export
      const rows = [];
      const headers = ['#', 'الاسم', 'الهاتف', 'البريد', 'الولاية', 'النوع', 'التاريخ'];
      rows.push(headers.join(','));
      
      const tbody = document.getElementById('leadsTableBody');
      tbody.querySelectorAll('tr').forEach((row, i) => {
        const cols = row.querySelectorAll('td');
        const data = [
          i + 1,
          cols[1].textContent,
          cols[2].textContent,
          cols[3].textContent,
          cols[4].textContent,
          cols[5].textContent,
          cols[6].textContent
        ];
        rows.push(data.join(','));
      });
      
      const csv = rows.join('\n');
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'solara-leads.csv';
      a.click();
    }
    
    // Initial load
    refreshData();
  </script>
</body>
</html>
